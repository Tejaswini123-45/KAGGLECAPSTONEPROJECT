<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>The Growth Hub ‚Äî AI Business Builder</title>

<style>
/* ---------------------------------------------------
   GLOBAL STYLING ‚Äî Professional, Clean, Modern
-----------------------------------------------------*/
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: Inter, system-ui, sans-serif;
  background: #f7f9fc;
  color: #1e1e1e;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* HEADER */
.header {
  padding: 18px 26px;
  background: white;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.header span.icon {
  background: #4f46e5;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  font-size: 18px;
}

/* MAIN LAYOUT */
.main { flex: 1; display: flex; overflow: hidden; }

/* SIDEBAR */
.sidebar {
  width: 300px;
  background: #ffffff;
  border-right: 1px solid #e5e7eb;
  overflow-y: auto;
  padding: 20px;
}
.sidebar h2 { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
.sidebar p { font-size: 13px; color: #6b7280; margin-bottom: 20px; }

.question-card {
  border: 1px solid #dcdce6;
  background: #fafafa;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: 0.2s ease;
}
.question-card strong { font-size: 14px; display: block; }
.question-card small { font-size: 11px; color: #6b7280; }

/* Completed */
.question-card.completed { border-color: #10b981; background: #ecfdf5; }
.question-card.completed strong { color: #059669; }

/* Current */
.question-card.current { border-color: #4f46e5; background: #eef2ff; }
.question-card.current strong { color: #4f46e5; font-weight: 600; }

/* Locked */
.question-card.locked { opacity: 0.55; cursor: not-allowed; }

/* CHAT AREA */
.chat-area {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message { margin-bottom: 8px; display: flex; }
.message.user { justify-content: flex-end; }
.message.bot { justify-content: flex-start; }

.msg-box {
  max-width: 70%;
  padding: 14px 18px;
  border-radius: 14px;
  font-size: 15px;
  line-height: 1.45;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  white-space: pre-wrap;
}
.message.user .msg-box {
  background: #4f46e5; color: white; border: none;
}

/* Typing Indicator */
.typing { display: flex; gap: 6px; margin: 10px; }
.dot { width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: blink 1.4s infinite; }
.dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%, 100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-4px); } }

/* INPUT BAR */
.input-bar {
  padding: 16px 20px;
  background: white;
  border-top: 1px solid #e5e7eb;
  display: flex;
  gap: 12px;
}
.input-bar input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}
.input-bar input:focus { outline: none; border-color: #4f46e5; background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08); }
button.send-btn { padding: 0 18px; border-radius: 12px; border: none; background: #4f46e5; color: white; font-size: 15px; cursor: pointer; }
button.send-btn:active { transform: translateY(1px); }

.status-line { font-size: 13px; color: #6b7280; margin-top: 8px; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <span class="icon">üöÄ</span> The Growth Hub ‚Äî Business Builder
</div>

<div class="main">

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Onboarding</h2>
    <p>Answer all questions to unlock your AI business advisor.</p>
    <div id="questionList"></div>
    <div class="status-line" id="onboardStatus">Onboarding progress: 0 / 10</div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area" id="chatArea">
    <div class="message bot">
      <div class="msg-box">
        üëã Welcome to <strong>The Growth Hub</strong>.<br/>
        Let's build your business together. I will ask you 10 critical founder questions.
      </div>
    </div>
  </div>

</div>

<!-- Input Bar -->
<div class="input-bar">
  <input id="userInput" placeholder="Type your answer‚Ä¶" onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendMessage(); }" />
  <button class="send-btn" onclick="sendMessage()">Send</button>
</div>

<script>
/* ---------- Frontend state ---------- */
const QUESTIONS = [
  "What problem are you solving?",
  "Who is your target audience?",
  "What is your unique value proposition?",
  "What exactly are you offering?",
  "How will the business make money?",
  "What systems do you need to run the business smoothly?",
  "How will customers discover your business?",
  "What is your brand identity?",
  "Why should people trust your business?",
  "What is your 1‚Äì3 year scaling vision?"
];

let currentIndex = 0;           // server-driven current question index
let onboardingComplete = false; // server-driven flag
let isProcessing = false;

/* ---------- Initialization ---------- */
renderSidebar();
initialOnboardingCheck();

/* ---------- Render Sidebar ---------- */
function renderSidebar() {
  const list = document.getElementById("questionList");
  list.innerHTML = "";

  QUESTIONS.forEach((q, i) => {
    const card = document.createElement("div");
    card.className = "question-card";

    if (onboardingComplete || i < currentIndex) {
      card.classList.add("completed");
    } else if (i === currentIndex) {
      card.classList.add("current");
      // clicking current focuses input + shows question
      card.addEventListener("click", () => promptCurrentQuestion());
    } else {
      card.classList.add("locked");
    }

    card.innerHTML = `<small>Question ${i + 1}</small><strong>${escapeHtml(q)}</strong>`;
    list.appendChild(card);
  }

  );

  const statusEl = document.getElementById("onboardStatus");
  const answered = onboardingComplete ? QUESTIONS.length : currentIndex;
  statusEl.textContent = `Onboarding progress: ${answered} / ${QUESTIONS.length}`;
}

/* ---------- Ask server for current onboarding question (on load) ---------- */
async function initialOnboardingCheck() {
  try {
    // special check message that backend understands
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "__CHECK_ONBOARDING__" })
    });

    const data = await res.json();
    // Expect: { response, status, question_index, onboarding_complete }
    if (data) {
      currentIndex = (typeof data.question_index === 'number') ? data.question_index : 0;
      onboardingComplete = !!data.onboarding_complete;
      renderSidebar();
      if (data.response) appendBot(data.response);
      // If onboarding not complete and response includes question, focus input
      if (!onboardingComplete) promptCurrentQuestion();
    }
  } catch (err) {
    appendBot("‚ö†Ô∏è Could not reach server to check onboarding. Make sure the backend is running.");
    console.error(err);
  }
}

/* ---------- UI helpers ---------- */
const chatArea = document.getElementById("chatArea");
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function appendUser(text) {
  const node = document.createElement("div");
  node.className = "message user";
  node.innerHTML = `<div class="msg-box">${escapeHtml(text)}</div>`;
  chatArea.appendChild(node);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function appendBot(text) {
  const node = document.createElement("div");
  node.className = "message bot";
  node.innerHTML = `<div class="msg-box">${escapeHtml(text)}</div>`;
  chatArea.appendChild(node);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* Typing bubble */
let typingBubble = null;
function showTyping() {
  if (typingBubble) return;
  typingBubble = document.createElement("div");
  typingBubble.className = "typing";
  typingBubble.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  chatArea.appendChild(typingBubble);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function hideTyping() {
  if (!typingBubble) return;
  typingBubble.remove();
  typingBubble = null;
}

/* Focus current question prompt (visually remind user) */
function promptCurrentQuestion() {
  const q = QUESTIONS[currentIndex];
  appendBot(`üìù Please answer: **Question ${currentIndex + 1} of ${QUESTIONS.length}:** ${q}`);
  document.getElementById('userInput').focus();
}

/* ---------- Send message ---------- */
async function sendMessage() {
  if (isProcessing) return;
  const inputEl = document.getElementById("userInput");
  const msg = inputEl.value.trim();
  if (!msg) return;

  appendUser(msg);
  inputEl.value = "";
  showTyping();
  isProcessing = true;

  try {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });

    const data = await res.json();
    hideTyping();
    isProcessing = false;

    // Data contract expected:
    // { response: str, status: "success"|"error", question_index: number|null, onboarding_complete: bool }
    if (!data) {
      appendBot("‚ö†Ô∏è Empty response from server.");
      return;
    }

    // Show bot message
    appendBot(data.response || "No response from server.");

    // Update client-side progress from server authoritative state
    if (typeof data.question_index === 'number') currentIndex = data.question_index;
    if (typeof data.onboarding_complete === 'boolean') onboardingComplete = data.onboarding_complete;

    renderSidebar();

    // If bot says onboarding completed, show final summary prompt
    if (onboardingComplete) {
      appendBot("üéâ Onboarding complete. You can now ask anything about your business.");
    } else {
      // If server responds with next question, auto-focus input
      document.getElementById("userInput").focus();
    }

  } catch (err) {
    hideTyping();
    isProcessing = false;
    console.error(err);
    appendBot("‚ùå Error connecting to server. Make sure backend (port 8000) is running.");
  }
}
</script>

</body>
</html>
